<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ezra's Space Adventure!</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: 'Courier New', monospace;
            color: #fff;
        }
        #gameCanvas {
            border: 3px solid #00ff00;
            background: #000;
            box-shadow: 0 0 20px #00ff00;
        }
        .info {
            margin-top: 20px;
            font-size: 18px;
            text-align: center;
        }
        .controls {
            margin-top: 10px;
            padding: 15px;
            background: #111;
            border: 2px solid #00ff00;
            border-radius: 10px;
        }
        .title {
            font-size: 32px;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="title">ü§ñ EZRA'S SPACE ADVENTURE üöÄ</div>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div class="info">
        <div style="font-size: 24px; color: #00ff00; margin-bottom: 10px;"><span id="message">Welcome! Starting adventure...</span></div>
        <div>Dimension: <span id="dimension">1</span> | Power-Ups: <span id="powerups">0</span> | Score: <span id="score">0</span></div>
    </div>
    <div class="controls">
        <strong>Controls:</strong> Arrow Keys OR Mouse = Move | M = Toggle Mouse/Keyboard | SPACEBAR = Shoot | 1-4 = Switch Weapons
    </div>

    <script type="module">
        import { GameEngine } from './src/engine/GameEngine.js';
        import { Player } from './src/entities/Player.js';
        import { DimensionManager } from './src/dimensions/DimensionManager.js';
        import { CollectionDimension } from './src/dimensions/CollectionDimension.js';
        import { BossDimension } from './src/dimensions/BossDimension.js';
        import { MathPuzzleDimension } from './src/dimensions/MathPuzzleDimension.js';
        import { AlienBoss } from './src/entities/AlienBoss.js';
        import { MiniDragonBoss, DragonBoss } from './src/entities/DragonBoss.js';
        import { IceShooter, FireShooter, GiantSword, BigBomb } from './src/weapons/EzraWeapons.js';
        import { createExplosion, createHitEffect, createSparkle } from './src/effects/Particle.js';

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Initialize game engine
        const engine = new GameEngine();

        // Create player
        const player = new Player(385, 500);
        engine.addEntity(player);

        // Give player Ezra's favorite weapons!
        player.weapon = new IceShooter(); // Start with Ice Shooter
        player.inventory = [
            new IceShooter(),
            new FireShooter(),
            new GiantSword(),
            new BigBomb()
        ];
        let currentWeaponIndex = 0;

        // Create dimension manager
        const dimensionManager = new DimensionManager();

        // Add dimensions
        dimensionManager.addDimension(new CollectionDimension(1, 'Power-Up Hunt'));
        dimensionManager.addDimension(new BossDimension(2, 'Alien Battle', new AlienBoss(300, 50), 5));
        dimensionManager.addDimension(new MathPuzzleDimension(3, 'Math Puzzle Challenge'));
        dimensionManager.addDimension(new BossDimension(4, 'Mini Dragon', new MiniDragonBoss(300, 50), 4));
        dimensionManager.addDimension(new BossDimension(5, 'FINAL: Dragon Boss', new DragonBoss(300, 50), 10));

        // Start first dimension
        let currentDimension = dimensionManager.getCurrentDimension();
        currentDimension.onEnter(engine.state);

        // Game state
        let gameWon = false;
        let gameOver = false;
        let gameStarted = false;

        // Health system: track hits when you have 0 power-ups
        let hitsWithZeroPowerups = 0;
        const MAX_HITS = 5;

        // Player projectiles
        let playerProjectiles = [];

        // Particle effects
        let particles = [];

        // Shooting - FAST and ACTION-PACKED!
        let shootCooldown = 0;
        const SHOOT_RATE = 5; // Frames between shots - RAPID FIRE!

        // Mouse movement option
        let useMouseMovement = false;
        let mouseX = 400;
        let mouseY = 500;

        canvas.addEventListener('mousemove', (e) => {
            if (!useMouseMovement) return;
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
        });

        canvas.addEventListener('click', () => {
            useMouseMovement = true; // Click to enable mouse movement
        });

        // Keyboard input
        const keys = {};
        window.addEventListener('keydown', (e) => {
            // Press M to toggle mouse movement
            if (e.key === 'm' || e.key === 'M') {
                useMouseMovement = !useMouseMovement;
                return;
            }

            // Using arrow keys disables mouse movement
            if (e.key.startsWith('Arrow')) {
                useMouseMovement = false;
            }
            keys[e.key] = true;

            // Math dimension needs keyboard input
            if (currentDimension && currentDimension.handleKeyPress) {
                currentDimension.handleKeyPress(e.key);
                if (e.key >= '0' && e.key <= '9' || e.key === 'Backspace' || e.key === 'Enter') {
                    e.preventDefault();
                }
            }

            if (e.key === ' ') {
                e.preventDefault();

                // Start game with spacebar
                if (!gameStarted) {
                    gameStarted = true;
                }
            }

            // Switch weapons with number keys (only if not in math dimension)
            if (!currentDimension || !currentDimension.handleKeyPress) {
                if (e.key >= '1' && e.key <= '4') {
                    const index = parseInt(e.key) - 1;
                    if (index < player.inventory.length) {
                        currentWeaponIndex = index;
                        player.weapon = player.inventory[currentWeaponIndex];
                    }
                }
            }
        });

        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // Create stars
        const stars = [];
        for (let i = 0; i < 100; i++) {
            stars.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: Math.random() * 2,
                speed: Math.random() * 2 + 1
            });
        }

        // Game loop
        let lastTime = 0;
        function gameLoop(currentTime) {
            const deltaTime = Math.min((currentTime - lastTime) / 16.67, 2); // Normalize to 60fps, cap at 2x
            lastTime = currentTime;

            // Title screen
            if (!gameStarted) {
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Draw stars
                stars.forEach(star => {
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(star.x, star.y, star.size, star.size);
                });

                // Title
                ctx.fillStyle = '#00ff00';
                ctx.font = 'bold 56px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText("EZRA'S", 400, 180);
                ctx.fillText("SPACE ADVENTURE", 400, 250);

                // Robot preview
                player.x = 385;
                player.y = 300;
                player.render(ctx);

                // Instructions
                ctx.fillStyle = '#ffff00';
                ctx.font = '28px Courier New';
                ctx.fillText('Press SPACEBAR to Start!', 400, 450);

                ctx.fillStyle = '#fff';
                ctx.font = '18px Courier New';
                ctx.fillText('Arrow Keys = Move | Space = Shoot | 1-4 = Switch Weapons', 400, 520);

                requestAnimationFrame(gameLoop);
                return;
            }

            // Handle player input
            let vx = 0, vy = 0;

            if (useMouseMovement) {
                // Mouse movement - move towards mouse position
                const dx = mouseX - player.x;
                const dy = mouseY - player.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance > 5) { // Dead zone
                    vx = (dx / distance) * player.speed;
                    vy = (dy / distance) * player.speed;
                }
            } else {
                // Keyboard movement
                if (keys['ArrowLeft']) vx = -player.speed;
                if (keys['ArrowRight']) vx = player.speed;
                if (keys['ArrowUp']) vy = -player.speed;
                if (keys['ArrowDown']) vy = player.speed;
            }

            player.setVelocity(vx, vy);

            // RAPID FIRE SHOOTING!
            if (keys[' '] && shootCooldown <= 0 && player.weapon) {
                const newProjectiles = player.weapon.fire(player, engine.state.entities);
                playerProjectiles.push(...newProjectiles);
                shootCooldown = SHOOT_RATE;
            }
            if (shootCooldown > 0) shootCooldown -= deltaTime;

            // Constrain player to canvas
            if (player.x < 0) player.x = 0;
            if (player.x > canvas.width - player.width) player.x = canvas.width - player.width;
            if (player.y < 0) player.y = 0;
            if (player.y > canvas.height - player.height) player.y = canvas.height - player.height;

            // Update engine
            engine.update(deltaTime);

            // Update current dimension (pass player for chasing enemy)
            currentDimension.update(deltaTime, engine.state, player);

            // Update player projectiles
            playerProjectiles = playerProjectiles.filter(p => {
                p.update(deltaTime);
                return p.active;
            });

            // Update particles
            particles = particles.filter(p => {
                p.update(deltaTime);
                return p.active;
            });

            // Collision detection - player projectiles vs boss
            if (currentDimension.type === 'boss' && currentDimension.boss && !currentDimension.boss.defeated) {
                playerProjectiles.forEach(proj => {
                    if (proj.active && proj.collidesWith(currentDimension.boss)) {
                        currentDimension.boss.takeDamage(proj.damage);
                        proj.destroy();
                        engine.state.score += 10;

                        // Hit effect!
                        particles.push(...createHitEffect(proj.x + proj.width / 2, proj.y + proj.height / 2, proj.color));

                        // Boss defeated explosion!
                        if (currentDimension.boss.defeated) {
                            particles.push(...createExplosion(
                                currentDimension.boss.x + currentDimension.boss.width / 2,
                                currentDimension.boss.y + currentDimension.boss.height / 2,
                                currentDimension.boss.color,
                                40
                            ));
                        }
                    }
                });
            }

            // Collision detection - enemy projectiles vs player
            const enemyProjectiles = currentDimension.getEnemyProjectiles ? currentDimension.getEnemyProjectiles() : [];
            enemyProjectiles.forEach(proj => {
                if (proj.active && proj.collidesWith(player)) {
                    player.removePowerup();
                    proj.destroy();

                    // Health system: track hits at 0 power-ups
                    if (player.powerups === 0) {
                        hitsWithZeroPowerups++;
                        if (hitsWithZeroPowerups >= MAX_HITS) {
                            // RESTART LEVEL!
                            currentDimension.onEnter(engine.state);
                            hitsWithZeroPowerups = 0;
                            playerProjectiles = [];
                        }
                    } else {
                        hitsWithZeroPowerups = 0; // Reset if you have power-ups
                    }
                }
            });

            // Collision detection - chasing enemy vs player
            const chasingEnemy = currentDimension.getChasingEnemy ? currentDimension.getChasingEnemy() : null;
            if (chasingEnemy && chasingEnemy.collidesWith(player)) {
                player.removePowerup();

                // Health system: track hits at 0 power-ups
                if (player.powerups === 0) {
                    hitsWithZeroPowerups++;
                    if (hitsWithZeroPowerups >= MAX_HITS) {
                        // RESTART LEVEL!
                        currentDimension.onEnter(engine.state);
                        hitsWithZeroPowerups = 0;
                        playerProjectiles = [];
                    }
                } else {
                    hitsWithZeroPowerups = 0; // Reset if you have power-ups
                }

                // Push player away
                const dx = player.x - chasingEnemy.x;
                const dy = player.y - chasingEnemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance > 0) {
                    player.x += (dx / distance) * 20;
                    player.y += (dy / distance) * 20;
                }
            }

            // Collision detection - power-ups
            const powerups = currentDimension.getPowerUps ? currentDimension.getPowerUps() : [];
            powerups.forEach(powerup => {
                if (powerup.active && powerup.collidesWith(player)) {
                    player.addPowerup();
                    powerup.collect();
                    if (currentDimension.collectPowerup) {
                        currentDimension.collectPowerup();
                    }
                    engine.state.score += 50;

                    // Sparkle effect!
                    particles.push(...createSparkle(powerup.x + powerup.width / 2, powerup.y + powerup.height / 2));
                }
            });

            // Collision detection - damage traps
            const traps = currentDimension.getTraps ? currentDimension.getTraps() : [];
            traps.forEach(trap => {
                if (trap.active && trap.collidesWith(player)) {
                    // OUCH! Lose power-ups!
                    player.removePowerup();
                    player.removePowerup();
                    player.removePowerup(); // Lose 3 power-ups!
                    trap.trigger();

                    // Red explosion effect!
                    particles.push(...createHitEffect(trap.x + trap.width / 2, trap.y + trap.height / 2, '#ff0000'));
                }
            });

            // Check for dimension completion
            if (currentDimension.completed && dimensionManager.canAdvance()) {
                dimensionManager.nextDimension();
                currentDimension = dimensionManager.getCurrentDimension();
                if (currentDimension) {
                    currentDimension.onEnter(engine.state);
                    playerProjectiles = []; // Clear projectiles
                } else {
                    // No more dimensions - YOU WIN!
                    gameWon = true;
                }
            } else if (currentDimension.completed && !dimensionManager.canAdvance()) {
                // Final dimension completed!
                gameWon = true;
            }

            // Update stars
            stars.forEach(star => {
                star.y += star.speed * deltaTime;
                if (star.y > canvas.height) {
                    star.y = 0;
                    star.x = Math.random() * canvas.width;
                }
            });

            // === RENDER ===
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw stars
            stars.forEach(star => {
                ctx.fillStyle = '#fff';
                ctx.fillRect(star.x, star.y, star.size, star.size);
            });

            // Render current dimension
            if (currentDimension) {
                currentDimension.render(ctx);
            }

            // Draw player projectiles
            playerProjectiles.forEach(p => p.render(ctx));

            // Draw particles
            particles.forEach(p => p.render(ctx));

            // Draw player
            player.render(ctx);

            // Draw weapon indicator
            ctx.fillStyle = '#fff';
            ctx.font = '16px Courier New';
            ctx.textAlign = 'left';
            ctx.fillText(`Weapon: ${player.weapon ? player.weapon.name : 'None'}`, 10, 30);
            ctx.font = '12px Courier New';
            ctx.fillText('(Press 1-4 to switch)', 10, 50);

            // Movement mode indicator
            ctx.fillStyle = useMouseMovement ? '#00ff00' : '#fff';
            ctx.font = '14px Courier New';
            ctx.fillText(`Move: ${useMouseMovement ? 'MOUSE' : 'KEYBOARD'}`, 10, 75);
            ctx.font = '10px Courier New';
            ctx.fillStyle = '#888';
            ctx.fillText('(Press M to toggle)', 10, 90);

            // Health indicator (when at 0 power-ups)
            if (player.powerups === 0 && hitsWithZeroPowerups > 0) {
                ctx.fillStyle = '#ff0000';
                ctx.font = 'bold 20px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText(`‚ö†Ô∏è HITS: ${hitsWithZeroPowerups}/${MAX_HITS} ‚ö†Ô∏è`, 400, 580);
                ctx.font = '14px Courier New';
                ctx.fillText('Get power-ups or restart level!', 400, 595);
            }

            // Victory screen
            if (gameWon) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = '#00ff00';
                ctx.font = 'bold 64px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText('YOU WIN!', 400, 250);

                ctx.fillStyle = '#ffff00';
                ctx.font = '32px Courier New';
                ctx.fillText('The Dragon is Defeated!', 400, 320);

                ctx.fillStyle = '#fff';
                ctx.font = '24px Courier New';
                ctx.fillText(`Final Score: ${engine.state.score}`, 400, 380);
                ctx.fillText(`Power-Ups: ${player.powerups}`, 400, 420);

                ctx.font = '18px Courier New';
                ctx.fillText('Press F5 to play again', 400, 470);
            }

            // Update UI
            document.getElementById('dimension').textContent = currentDimension ? currentDimension.number : '?';
            document.getElementById('powerups').textContent = player.powerups;
            document.getElementById('score').textContent = engine.state.score;
            document.getElementById('message').textContent = currentDimension ? currentDimension.name : 'Loading...';

            requestAnimationFrame(gameLoop);
        }

        // Start game
        engine.start();
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
